# é‚®ç®±éªŒè¯æµç¨‹æ–‡æ¡£

## æµç¨‹æ¦‚è¿°

æ–°çš„éªŒè¯æµç¨‹ï¼š**å…ˆéªŒè¯é‚®ç®±ï¼Œå†è¿›è¡ŒAIåˆ†æ**

è¿™æ ·è®¾è®¡çš„ä¼˜åŠ¿ï¼š
- âœ… é¿å…æ— æ•ˆé‚®ç®±æµªè´¹AIåˆ†æèµ„æº
- âœ… ç”¨æˆ·ä½“éªŒæ›´æµç•…ï¼ˆéªŒè¯å¿«ï¼Œåˆ†ææ…¢ï¼‰
- âœ… é™ä½è¿è¥æˆæœ¬
- âœ… é˜²æ­¢æ¶æ„æäº¤

## å®Œæ•´æµç¨‹

```
ç”¨æˆ·æäº¤URL + é‚®ç®±
    â†“
éªŒè¯URLæ ¼å¼ âœ“
    â†“
æ£€æŸ¥URLæ˜¯å¦å·²å­˜åœ¨ âœ“
    â†“
ç”Ÿæˆ6ä½éªŒè¯ç 
    â†“
å­˜å‚¨åˆ° agent_submissions è¡¨ï¼ˆagent_data = nullï¼‰
    â†“
å‘é€éªŒè¯é‚®ä»¶ ğŸ“§
    â†“
ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    â†“
éªŒè¯éªŒè¯ç  âœ“
    â†“
ã€å¼€å§‹AIåˆ†æã€‘analyzeURL()
    â†“
æå–Agentä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€ç‰¹æ€§ç­‰ï¼‰
    â†“
åˆ›å»ºAgentè®°å½•
    â†“
æ›´æ–° agent_submissionsï¼ˆverified = true, agent_idï¼‰
    â†“
å‘é€æˆåŠŸé€šçŸ¥é‚®ä»¶ ğŸ‰
    â†“
è¿”å›Agentä¿¡æ¯å’Œé“¾æ¥
```

## APIç«¯ç‚¹

### 1. POST /api/send-verification

**åŠŸèƒ½**ï¼šå‘é€éªŒè¯ç ï¼ˆä¸åšAIåˆ†æï¼‰

**è¯·æ±‚**ï¼š
```json
{
  "url": "https://chat.openai.com/g/...",
  "email": "user@example.com"
}
```

**å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯URLæ ¼å¼ï¼ˆvalidateURLï¼‰
2. æ£€æŸ¥URLæ˜¯å¦å·²å­˜åœ¨
3. ç”Ÿæˆ6ä½éªŒè¯ç 
4. å­˜å‚¨åˆ° agent_submissionsï¼ˆagent_data = nullï¼‰
5. å‘é€éªŒè¯é‚®ä»¶
6. è¿”å›æˆåŠŸæ¶ˆæ¯

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "éªŒè¯ç å·²å‘é€åˆ°ä½ çš„é‚®ç®±"
}
```

**é”™è¯¯å¤„ç†**ï¼š
- 400: URLæ ¼å¼é”™è¯¯ã€é‚®ç®±æ ¼å¼é”™è¯¯
- 409: URLå·²å­˜åœ¨
- 429: è¯·æ±‚è¿‡äºé¢‘ç¹ï¼ˆé€Ÿç‡é™åˆ¶ï¼‰
- 500: å‘é€é‚®ä»¶å¤±è´¥

### 2. POST /api/verify-and-publish

**åŠŸèƒ½**ï¼šéªŒè¯é‚®ç®± â†’ åˆ†æURL â†’ ä¸Šæ¶Agent

**è¯·æ±‚**ï¼š
```json
{
  "email": "user@example.com",
  "code": "123456"
}
```

**å¤„ç†æµç¨‹**ï¼š
1. éªŒè¯éªŒè¯ç ï¼ˆä» agent_submissions æŸ¥è¯¢ï¼‰
2. æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰
3. **å¼€å§‹AIåˆ†æ**ï¼šanalyzeURL(submission.url)
4. æå–Agentä¿¡æ¯
5. åˆ›å»ºAgentè®°å½•
6. æ›´æ–° agent_submissionsï¼ˆverified = trueï¼‰
7. å‘é€æˆåŠŸé€šçŸ¥é‚®ä»¶
8. è¿”å›Agentä¿¡æ¯

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "ğŸ‰ Agentå·²æˆåŠŸä¸Šæ¶ï¼",
  "agent": {
    "id": "uuid",
    "name": "Agentåç§°",
    "slug": "agent-slug",
    "url": "/agents/agent-slug"
  }
}
```

**é”™è¯¯å¤„ç†**ï¼š
- 400: éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ
- 422: URLåˆ†æå¤±è´¥
- 500: åˆ›å»ºAgentå¤±è´¥

## æ•°æ®åº“è¡¨

### agent_submissions

```sql
CREATE TABLE agent_submissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email VARCHAR(255) NOT NULL,
  url TEXT NOT NULL,
  verification_code VARCHAR(6) NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  verified BOOLEAN DEFAULT false,
  agent_id UUID REFERENCES agents(id),
  agent_data JSONB,  -- éªŒè¯åæ‰å¡«å……
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(email, url)
);
```

**å­—æ®µè¯´æ˜**ï¼š
- `agent_data`: éªŒè¯å‰ä¸º nullï¼ŒéªŒè¯åå­˜å‚¨AIåˆ†æç»“æœ
- `verified`: é‚®ç®±æ˜¯å¦å·²éªŒè¯
- `agent_id`: åˆ›å»ºAgentåçš„IDå¼•ç”¨

## å‰ç«¯ç»„ä»¶

### PublishAgentSection

**æ­¥éª¤1: è¡¨å•ï¼ˆformï¼‰**
- è¾“å…¥URLå’Œé‚®ç®±
- åŒæ„æœåŠ¡æ¡æ¬¾
- ç‚¹å‡»"å‘é€éªŒè¯ç "
- è°ƒç”¨ `/api/send-verification`

**æ­¥éª¤2: éªŒè¯ï¼ˆverifyï¼‰**
- æ˜¾ç¤ºé‚®ç®±åœ°å€
- è¾“å…¥6ä½éªŒè¯ç 
- ç‚¹å‡»"éªŒè¯å¹¶ä¸Šæ¶"
- è°ƒç”¨ `/api/verify-and-publish`
- æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆAIåˆ†æä¸­...ï¼‰

**æ­¥éª¤3: æˆåŠŸï¼ˆsuccessï¼‰**
- æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
- æ˜¾ç¤ºAgentåç§°
- æä¾›æŸ¥çœ‹é“¾æ¥
- å¯ç»§ç»­å‘å¸ƒå…¶ä»–Agent

## é‚®ä»¶æ¨¡æ¿

### éªŒè¯ç é‚®ä»¶

```
ä¸»é¢˜: éªŒè¯ä½ çš„é‚®ç®± - Super Alpha Agent

ä½ å¥½ï¼

ä½ çš„éªŒè¯ç æ˜¯ï¼š123456

æ­¤éªŒè¯ç å°†åœ¨10åˆ†é’Ÿåè¿‡æœŸã€‚

å¦‚æœè¿™ä¸æ˜¯ä½ çš„æ“ä½œï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚
```

### æˆåŠŸé€šçŸ¥é‚®ä»¶

```
ä¸»é¢˜: ğŸ‰ ä½ çš„Agentå·²æˆåŠŸä¸Šæ¶ï¼

ä½ å¥½ï¼

ä½ æäº¤çš„Agent "Agentåç§°" å·²æˆåŠŸä¸Šæ¶åˆ° Super Alpha Agent å¹³å°ã€‚

æŸ¥çœ‹ä½ çš„Agent: https://superalphaagent.com/agents/agent-slug

æ„Ÿè°¢ä½ çš„è´¡çŒ®ï¼
```

## å®‰å…¨æªæ–½

### 1. é€Ÿç‡é™åˆ¶
- æ¯é‚®ç®±æ¯åˆ†é’Ÿæœ€å¤š3æ¬¡è¯·æ±‚
- ä½¿ç”¨å†…å­˜Mapå­˜å‚¨ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨Redisï¼‰

```typescript
const rateLimitMap = new Map<string, { count: number; resetTime: number }>()

function checkRateLimit(key: string, maxRequests = 3, windowMs = 60000): boolean {
  // å®ç°é€»è¾‘...
}
```

### 2. éªŒè¯ç è¿‡æœŸ
- 10åˆ†é’Ÿæœ‰æ•ˆæœŸ
- è¿‡æœŸåéœ€é‡æ–°è·å–

### 3. URLå»é‡
- æ£€æŸ¥URLæ˜¯å¦å·²å­˜åœ¨
- é˜²æ­¢é‡å¤æäº¤

### 4. é‚®ç®±éªŒè¯
- å¿…é¡»éªŒè¯é‚®ç®±æ‰èƒ½ä¸Šæ¶
- é˜²æ­¢åƒåœ¾æäº¤

## æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†
- æˆåŠŸé€šçŸ¥é‚®ä»¶å¼‚æ­¥å‘é€
- ä¸é˜»å¡å“åº”

```typescript
sendPublishSuccessEmail(email, agent.name, agent.slug).catch(err => {
  console.error('Send success email failed:', err)
})
```

### 2. èµ„æºèŠ‚çº¦
- éªŒè¯å‰ä¸åšAIåˆ†æ
- åªå¯¹æœ‰æ•ˆé‚®ç®±è¿›è¡Œåˆ†æ
- é¢„è®¡èŠ‚çœ 30-50% AIæˆæœ¬

### 3. ç”¨æˆ·ä½“éªŒ
- éªŒè¯ç å‘é€å¿«ï¼ˆ< 1ç§’ï¼‰
- AIåˆ†ææ…¢ï¼ˆ5-10ç§’ï¼‰
- åˆ†ç¦»ä¸¤ä¸ªæ­¥éª¤ï¼Œä½“éªŒæ›´å¥½

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯

1. **éªŒè¯ç å‘é€å¤±è´¥**
   - æ£€æŸ¥ Resend API Key
   - æ£€æŸ¥é‚®ç®±æ ¼å¼
   - æŸ¥çœ‹ Resend Dashboard æ—¥å¿—

2. **éªŒè¯ç æ— æ•ˆ**
   - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
   - æ£€æŸ¥é‚®ç®±å’ŒéªŒè¯ç æ˜¯å¦åŒ¹é…
   - ç¡®è®¤æ•°æ®åº“è®°å½•å­˜åœ¨

3. **AIåˆ†æå¤±è´¥**
   - æ£€æŸ¥ OpenRouter API Key
   - æ£€æŸ¥URLæ˜¯å¦å¯è®¿é—®
   - æŸ¥çœ‹é”™è¯¯æ—¥å¿—

4. **Agentåˆ›å»ºå¤±è´¥**
   - æ£€æŸ¥ Supabase è¿æ¥
   - æ£€æŸ¥æ•°æ®æ ¼å¼
   - æŸ¥çœ‹æ•°æ®åº“çº¦æŸ

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
# æµ‹è¯•éªŒè¯ç å‘é€
npm test -- send-verification --run

# æµ‹è¯•éªŒè¯å’Œå‘å¸ƒ
npm test -- verify-and-publish --run
```

### æ‰‹åŠ¨æµ‹è¯•

1. è®¿é—®é¦–é¡µ `http://localhost:3000`
2. æ»šåŠ¨åˆ°"å‘å¸ƒä½ çš„AI Agent"åŒºåŸŸ
3. è¾“å…¥æµ‹è¯•URLå’Œé‚®ç®±
4. æ£€æŸ¥é‚®ç®±æ”¶åˆ°éªŒè¯ç 
5. è¾“å…¥éªŒè¯ç 
6. ç­‰å¾…AIåˆ†æå®Œæˆ
7. éªŒè¯Agentå·²åˆ›å»º

### æµ‹è¯•ç”¨ä¾‹

| åœºæ™¯ | è¾“å…¥ | æœŸæœ›ç»“æœ |
|------|------|----------|
| æœ‰æ•ˆæäº¤ | æ­£ç¡®URL + é‚®ç®± | å‘é€éªŒè¯ç  |
| æ— æ•ˆURL | é”™è¯¯URLæ ¼å¼ | 400é”™è¯¯ |
| æ— æ•ˆé‚®ç®± | é”™è¯¯é‚®ç®±æ ¼å¼ | 400é”™è¯¯ |
| URLå·²å­˜åœ¨ | å·²å­˜åœ¨çš„URL | 409é”™è¯¯ |
| é€Ÿç‡é™åˆ¶ | è¿ç»­4æ¬¡è¯·æ±‚ | 429é”™è¯¯ |
| éªŒè¯ç é”™è¯¯ | é”™è¯¯éªŒè¯ç  | 400é”™è¯¯ |
| éªŒè¯ç è¿‡æœŸ | 11åˆ†é’ŸåéªŒè¯ | 400é”™è¯¯ |
| æˆåŠŸä¸Šæ¶ | æ­£ç¡®éªŒè¯ç  | åˆ›å»ºAgent |

## ç›‘æ§æŒ‡æ ‡

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š

1. **è½¬åŒ–ç‡**
   - å‘é€éªŒè¯ç æ•°
   - éªŒè¯æˆåŠŸæ•°
   - è½¬åŒ–ç‡ = éªŒè¯æˆåŠŸ / å‘é€éªŒè¯ç 

2. **å¤±è´¥ç‡**
   - é‚®ä»¶å‘é€å¤±è´¥ç‡
   - AIåˆ†æå¤±è´¥ç‡
   - Agentåˆ›å»ºå¤±è´¥ç‡

3. **æ€§èƒ½**
   - éªŒè¯ç å‘é€è€—æ—¶
   - AIåˆ†æè€—æ—¶
   - ç«¯åˆ°ç«¯è€—æ—¶

4. **æˆæœ¬**
   - AI APIè°ƒç”¨æ¬¡æ•°
   - é‚®ä»¶å‘é€æ¬¡æ•°
   - æ¯ä¸ªAgentçš„æˆæœ¬

## æœªæ¥ä¼˜åŒ–

1. **æ‰¹é‡å¤„ç†**
   - æ”¯æŒæ‰¹é‡æäº¤URL
   - å¼‚æ­¥é˜Ÿåˆ—å¤„ç†

2. **æ™ºèƒ½å»é‡**
   - æ£€æµ‹ç›¸ä¼¼URL
   - åˆå¹¶é‡å¤Agent

3. **è´¨é‡æ§åˆ¶**
   - äººå·¥å®¡æ ¸æœºåˆ¶
   - è‡ªåŠ¨è´¨é‡è¯„åˆ†

4. **ç”¨æˆ·ç®¡ç†**
   - ç”¨æˆ·è´¦å·ç³»ç»Ÿ
   - æäº¤å†å²è®°å½•

## æ€»ç»“

æ–°çš„éªŒè¯æµç¨‹å®ç°äº†ï¼š

âœ… **å…ˆéªŒè¯é‚®ç®±ï¼Œå†AIåˆ†æ** - èŠ‚çœèµ„æº  
âœ… **æ¸…æ™°çš„ä¸‰æ­¥æµç¨‹** - ç”¨æˆ·ä½“éªŒå¥½  
âœ… **å®Œå–„çš„é”™è¯¯å¤„ç†** - ç¨³å®šå¯é   
âœ… **å®‰å…¨æªæ–½** - é˜²æ­¢æ»¥ç”¨  
âœ… **æ€§èƒ½ä¼˜åŒ–** - å¿«é€Ÿå“åº”  

è¿™ä¸ªæµç¨‹æ—¢ä¿è¯äº†æ•°æ®è´¨é‡ï¼Œåˆä¼˜åŒ–äº†æˆæœ¬å’Œç”¨æˆ·ä½“éªŒï¼
